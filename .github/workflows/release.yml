name: Release

on:
  push:
    tags:
      - "v*"

permissions: {}

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Gate release on CI passing - rerun the same checks
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GOLANGCI_LINT_VERSION: v2.7.2
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          # Disable cache for release builds to prevent cache poisoning
          cache: false

      - name: Build golangci-lint from source
        run: |
          git clone --branch ${{ env.GOLANGCI_LINT_VERSION }} --single-branch --depth 1 -c advice.detachedHead=false -q https://github.com/golangci/golangci-lint.git
          cd golangci-lint
          go build -trimpath -ldflags "-X main.version=${{ env.GOLANGCI_LINT_VERSION }} -X main.date=$(date -u +%Y-%m-%d_%H:%M:%S)" -o golangci-lint ./cmd/golangci-lint
          sudo mv golangci-lint /usr/local/bin/
          golangci-lint --version

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          install-mode: none
          skip-cache: true
          args: --timeout=5m

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          # Disable cache for release builds to prevent cache poisoning
          cache: false

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc

      - name: Run go vet
        run: go vet ./...

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [lint, test]
    permissions:
      contents: write
      id-token: write # Required for keyless Sigstore signing
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Verify tag is on main branch
        env:
          TAG_REF: ${{ github.ref }}
        run: |
          # Get the commit the tag points to
          TAG_COMMIT=$(git rev-list -n 1 "$TAG_REF")

          # Check if this commit is reachable from main or master
          # This ensures the tag points to a commit that exists on main/master
          MAIN_EXISTS=$(git ls-remote --heads origin main | wc -l)
          MASTER_EXISTS=$(git ls-remote --heads origin master | wc -l)

          ON_MAIN=false

          if [ "$MAIN_EXISTS" -gt 0 ]; then
            if git merge-base --is-ancestor "$TAG_COMMIT" origin/main 2>/dev/null; then
              ON_MAIN=true
              echo "Tag commit is an ancestor of main branch"
            fi
          fi

          if [ "$MASTER_EXISTS" -gt 0 ]; then
            if git merge-base --is-ancestor "$TAG_COMMIT" origin/master 2>/dev/null; then
              ON_MAIN=true
              echo "Tag commit is an ancestor of master branch"
            fi
          fi

          if [ "$ON_MAIN" = "true" ]; then
            echo "Proceeding with release"
          else
            echo "ERROR: Tag must point to a commit on main or master branch"
            echo "Tag commit: $TAG_COMMIT"
            echo "This prevents releasing from feature branches."
            echo ""
            echo "To fix: merge your changes to main first, then tag the merge commit."
            exit 1
          fi

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          # Disable cache for release builds to prevent cache poisoning
          cache: false

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@deef08a0db64bfad603422135db61477b16cef56 # v0.20.0

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          COSIGN_EXPERIMENTAL: 1
